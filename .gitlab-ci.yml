#
#                           VELOXCHEM 1.0-RC2
#         ----------------------------------------------------
#                     An Electronic Structure Code
#
#  Copyright Â© 2018-2021 by VeloxChem developers. All rights reserved.
#  Contact: https://veloxchem.org/contact
#
#  SPDX-License-Identifier: LGPL-3.0-or-later
#
#  This file is part of VeloxChem.
#
#  VeloxChem is free software: you can redistribute it and/or modify it under
#  the terms of the GNU Lesser General Public License as published by the Free
#  Software Foundation, either version 3 of the License, or (at your option)
#  any later version.
#
#  VeloxChem is distributed in the hope that it will be useful, but WITHOUT
#  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
#  FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public
#  License for more details.
#
#  You should have received a copy of the GNU Lesser General Public License
#  along with VeloxChem. If not, see <https://www.gnu.org/licenses/>.

stages:
  - build
  - test

.monkey:setup:
  image: ghcr.io/enccs/meta-vlx/vlx-ci_ubuntu-20.04:sha-0128a87
  variables:
    OMP_NUM_THREADS: "6"
    GTESTROOT: "/usr"
    GTESTLIB: "/usr/lib/x86_64-linux-gnu"
  before_script:
    - source /opt/docker/etc/intel-env.sh

monkey:build:
  extends: .monkey:setup
  stage: build
  script:
    - python config/generate_setup.py
    - make -j 6 -C src release
    - make -j 6 -C unit_tests release
  artifacts:
    paths:
      - build
    expire_in: 2 hours

monkey:unit_tests:
  extends: .monkey:setup
  stage: test
  needs: ["monkey:build"]
  script:
    - ./build/bin/UnitTestVeloxChem.x

monkey:python_tests:
  extends: .monkey:setup
  stage: test
  variables:
    VLX_NUM_BUILD_JOBS: "6"
    CC: icc
    MPICC: mpiicc
  script:
    - python -m venv --clear venv
    - source venv/bin/activate
    - python -m pip install pytest pytest-cov
    - python -m pip install .[qmmm]
    - python -m pytest -v --cov=veloxchem --pyargs veloxchem
    - mpiexec -n 2 python -m pytest -v --pyargs veloxchem -m "solvers"
